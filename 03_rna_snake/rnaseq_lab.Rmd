---
title: "RNAseq minimal pipeline"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## RNAseq pipeline with Snakemake and R/Python code

For this laboratory we'll set up a RNASeq pipeline, from fastq up to counts and with some
coverage plots, using Snakemake.

We aim at writing a Snakefile that will automatically follow the steps we previously described in
the slides 'RNAseq_lab_tools'.

I've created 5 synthetic fastq files to represent 5 samples of RNAsequencing obtained
with an experiment on *Drosophila Melanogaster*, they
are called 'a','b','c','d' and 'e' and you'll find them in '/home/stud0/aibh_integromics/03_rna_snake/fastq' our
our server (there is also a zip on moodle).
In '/home/stud0/aibh_integromics/03_rna_snake' you'll also find a skeleton for the Snakefile that you'll need to fill in where you see `# ...`

The suggestion is to review the RNAseq_lab_tools slides and divide this laboratory in 4 parts, described below.
They can be implemented separately.

A good way to organize the work could be to decide which step to code, then:

- try it out on the shell manually, to annotate the name of the output file(s) created by the command
- write the rule that will be able to execute it using Snakemake, using the appropriate wildcards to be able to work on all samples
- call it for a single sample to check that it works
- write the 'all' rule to automatically call it for all samples (not needed for all the rules, since for example all
the alignments will be called when you require all the outputs of the count rule, if you chained the rules correctly)

Do not worry about trying out the commands: the synthetic fastq files are very small! You can always use `snakemake -pn`
if you want to check which code would be run with a rule. Just limit yourselves to a single thread for multithreaded
commands!

The Snakefile skeleton has set up some variables with the relevant paths (pointing to STAR indexes, gtf files, ...) - you should
copy the Snakefile in a directory in your home and work there ('cp /home/stud0/aibh_integromics/03_rna_snake/Snakefile /home/studX/Snakefile'), filling the missing parts.
fastq files, STAR indexes etc should stay where they are (in /home/stud0/...), they all are readable
by your users so you will be able to access them as input files in your rules.

### QC

We'll limit ourselves to fastqc - write a rule to call it and an 'all' rule for all samples.
You'll need to point to the directory in my home to use the fastq there (do not copy them to your home to avoid
filling the disk too much!).
Copy the resulting html files to your local computer and inspect them, why do you think the results are so strange?

### Align and count

Use `STAR` and `featureCounts`.
For `featureCounts` use all the parameters we have seen, pay specific attention to using `-g gene_name`, to have the correct gene
identifiers (needed for the following pipeline steps) in its output.
Write an `all_counts` rule that gets all the output files generated by `featureCounts` and merge
them in a single one (`all_counts.tsv`) with different samples counts as columns - you can do this writing some python in the run directive or a small R script that you'll call in the rule.
To develop the R script interactively you can assign manually to a variable the values that snakemake will put
in the `snakemake@input` for the rule you've written.
When you are satisfied with what your code does, just link this variable to the input and set up the output one, then try out your rule.

Experiment rule chaining: is STAR executed automatically when you require a count file if the bam is not there?
If it's already there? Try different combinations removing (with the command 'rm filename') the obtained bam/count files.

### Find the expressed genes and obtain the bed with their exons.

If you inspect the tsv that you obtained in the previous section you'll see that the majority of the
genes have 0 reads. Write another rule that'll produce a tsv listing only read counts
for the genes with at least 1 read in at least one sample.

To study the coverage on these expressed genes you'll need to get their exons coordinates from the bed
file which path is in the `BED` variable. But...the identifiers in that bed file are not the same
used by `featureCounts` to count reads :(
You'll need to obtain a file that lists the expressed genes with the same identifiers of the bed.
I've created a file that can act as a *dictionary* for this translation: its path is in the MAP variable.
Write a rule that translates the identifiers of the expressed genes using this map and writes them in a 
column of the file `expressed_genes_counts_flybase.tsv`. Then write another one that starts from BED and this new file 
to create a smaller bed listing only the ids of the expressed genes. 

### Genebody coverage

Write the rules needed to call `geneBody_coverage.py`. Call it for sample 'a' and 'e', then copy the resulting
plots to your local computer and inspect them.

### Redo everything with a single command!

Experiment how Snakefile behaves: add a new sample to your samples (yes, you guessed right: 'f', the fastq file
is available in the same dir as the others) and call the rule to produce all counts. Which commands are executed? Why?

What would be called if one of the original fastq files would have been changed, instead?